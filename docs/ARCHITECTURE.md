# ì½˜ì„œíŠ¸ ì˜ˆì•½ ì„œë¹„ìŠ¤ - ì•„í‚¤í…ì²˜ ë¬¸ì„œ

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ì „ì²´ ì•„í‚¤í…ì²˜](#2-ì „ì²´-ì•„í‚¤í…ì²˜)
3. [ë„ë©”ì¸ë³„ ì•„í‚¤í…ì²˜](#3-ë„ë©”ì¸ë³„-ì•„í‚¤í…ì²˜)
4. [ê³„ì¸µ êµ¬ì¡°](#4-ê³„ì¸µ-êµ¬ì¡°)
5. [ë™ì‹œì„± ì œì–´](#5-ë™ì‹œì„±-ì œì–´)
6. [ì˜ˆì™¸ ì²˜ë¦¬](#6-ì˜ˆì™¸-ì²˜ë¦¬)
7. [ìŠ¤ì¼€ì¤„ë§](#7-ìŠ¤ì¼€ì¤„ë§)

---

## 1. ê°œìš”

### í”„ë¡œì íŠ¸ ëª©í‘œ
ì½˜ì„œíŠ¸ ì¢Œì„ ì˜ˆì•½ ì‹œìŠ¤í…œìœ¼ë¡œ, ëŒ€ê¸°ì—´ ê¸°ë°˜ íŠ¸ë˜í”½ ì œì–´ì™€ ë™ì‹œì„± ì²˜ë¦¬ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

### ê¸°ìˆ  ìŠ¤íƒ
| ë¶„ë¥˜ | ê¸°ìˆ  |
|------|------|
| Language | Java 21 |
| Framework | Spring Boot 3.4.1 |
| ORM | Spring Data JPA + Hibernate |
| Database | MySQL 8.0 |
| Build Tool | Gradle (Kotlin DSL) |
| Testing | JUnit 5, Mockito, Testcontainers |
| Documentation | OpenAPI 3.0 (Swagger) |

### ì•„í‚¤í…ì²˜ ì ìš© ì›ì¹™
- **ì˜ˆì•½/ê²°ì œ ë„ë©”ì¸**: í´ë¦° ì•„í‚¤í…ì²˜ (UseCase íŒ¨í„´)
- **ì½˜ì„œíŠ¸/í¬ì¸íŠ¸/ëŒ€ê¸°ì—´ ë„ë©”ì¸**: ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜ (Service íŒ¨í„´)

---

## 2. ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Interfaces Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ QueueControllerâ”‚ â”‚ConcertControllerâ”‚ â”‚ReservationControllerâ”‚ â”‚PaymentControllerâ”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â–¼               â–¼               â–¼               â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ QueueService â”‚ â”‚ConcertServiceâ”‚ â”‚ReserveSeatUseCaseâ”‚ â”‚ProcessPaymentUseCaseâ”‚
â”‚  â”‚  (Layered)   â”‚ â”‚  (Layered)   â”‚ â”‚   (Clean)    â”‚ â”‚    (Clean)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                      Application Layer                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â–¼               â–¼               â–¼               â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ QueueToken  â”‚ â”‚    Seat     â”‚ â”‚ Reservation â”‚ â”‚   Payment   â”‚    â”‚
â”‚  â”‚PointBalance â”‚ â”‚ConcertScheduleâ”‚              â”‚             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       Domain Layer                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚               â”‚               â”‚
          â–¼               â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Infrastructure Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Spring Data JPA Repositories                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         MySQL 8.0                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ë„ë©”ì¸ë³„ ì•„í‚¤í…ì²˜

### 3.1 ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜ (ëŒ€ê¸°ì—´, ì½˜ì„œíŠ¸, í¬ì¸íŠ¸)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Controller (Interfaces)     â”‚  â† HTTP ìš”ì²­ ì²˜ë¦¬
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Service (Application)    â”‚  â† ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Repository (Domain)       â”‚  â† ë°ì´í„° ì ‘ê·¼ ì¸í„°í˜ì´ìŠ¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Entity (Domain)          â”‚  â† ë„ë©”ì¸ ì—”í‹°í‹°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì ìš© ë„ë©”ì¸:**
- `QueueService` - ëŒ€ê¸°ì—´ í† í° ë°œê¸‰/ì¡°íšŒ
- `ConcertService` - ê³µì—° ë‚ ì§œ/ì¢Œì„ ì¡°íšŒ
- `PointService` - í¬ì¸íŠ¸ ì¶©ì „/ì°¨ê°

### 3.2 í´ë¦° ì•„í‚¤í…ì²˜ (ì˜ˆì•½, ê²°ì œ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Controller (Interfaces)     â”‚  â† HTTP ìš”ì²­ ì²˜ë¦¬
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      UseCase (Application)      â”‚  â† ìœ ìŠ¤ì¼€ì´ìŠ¤ ì¸í„°í˜ì´ìŠ¤
â”‚      UseCaseImpl                â”‚  â† ìœ ìŠ¤ì¼€ì´ìŠ¤ êµ¬í˜„ì²´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Repository (Domain)       â”‚  â† ë°ì´í„° ì ‘ê·¼ ì¸í„°í˜ì´ìŠ¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Entity (Domain)          â”‚  â† ë„ë©”ì¸ ì—”í‹°í‹° + ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì ìš© ë„ë©”ì¸:**
- `ReserveSeatUseCase` - ì¢Œì„ ì„ì‹œ ì˜ˆì•½
- `ProcessPaymentUseCase` - ê²°ì œ ì²˜ë¦¬

---

## 4. ê³„ì¸µ êµ¬ì¡°

### íŒ¨í‚¤ì§€ êµ¬ì¡°

```
src/main/java/kr/hhplus/be/server/
â”œâ”€â”€ ServerApplication.java
â”‚
â”œâ”€â”€ application/                    # ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ
â”‚   â”œâ”€â”€ concert/
â”‚   â”‚   â””â”€â”€ ConcertService.java         # ë ˆì´ì–´ë“œ
â”‚   â”œâ”€â”€ point/
â”‚   â”‚   â””â”€â”€ PointService.java           # ë ˆì´ì–´ë“œ
â”‚   â”œâ”€â”€ queue/
â”‚   â”‚   â””â”€â”€ QueueService.java           # ë ˆì´ì–´ë“œ
â”‚   â”œâ”€â”€ reservation/
â”‚   â”‚   â””â”€â”€ usecase/
â”‚   â”‚       â”œâ”€â”€ ReserveSeatUseCase.java       # ì¸í„°í˜ì´ìŠ¤
â”‚   â”‚       â””â”€â”€ ReserveSeatUseCaseImpl.java   # êµ¬í˜„ì²´
â”‚   â”œâ”€â”€ payment/
â”‚   â”‚   â””â”€â”€ usecase/
â”‚   â”‚       â”œâ”€â”€ ProcessPaymentUseCase.java    # ì¸í„°í˜ì´ìŠ¤
â”‚   â”‚       â””â”€â”€ ProcessPaymentUseCaseImpl.java
â”‚   â””â”€â”€ scheduler/
â”‚       â””â”€â”€ ExpirationScheduler.java    # ìŠ¤ì¼€ì¤„ëŸ¬
â”‚
â”œâ”€â”€ domain/                         # ë„ë©”ì¸ ê³„ì¸µ
â”‚   â”œâ”€â”€ concert/
â”‚   â”‚   â”œâ”€â”€ Seat.java                   # ì—”í‹°í‹°
â”‚   â”‚   â”œâ”€â”€ SeatStatus.java             # Enum
â”‚   â”‚   â”œâ”€â”€ ConcertSchedule.java
â”‚   â”‚   â”œâ”€â”€ SeatRepository.java         # ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤
â”‚   â”‚   â””â”€â”€ ConcertScheduleRepository.java
â”‚   â”œâ”€â”€ reservation/
â”‚   â”‚   â”œâ”€â”€ Reservation.java
â”‚   â”‚   â”œâ”€â”€ ReservationStatus.java
â”‚   â”‚   â””â”€â”€ ReservationRepository.java
â”‚   â”œâ”€â”€ payment/
â”‚   â”‚   â”œâ”€â”€ Payment.java
â”‚   â”‚   â”œâ”€â”€ PaymentStatus.java
â”‚   â”‚   â””â”€â”€ PaymentRepository.java
â”‚   â”œâ”€â”€ point/
â”‚   â”‚   â”œâ”€â”€ PointBalance.java
â”‚   â”‚   â””â”€â”€ PointBalanceRepository.java
â”‚   â””â”€â”€ queue/
â”‚       â”œâ”€â”€ QueueToken.java
â”‚       â”œâ”€â”€ TokenStatus.java
â”‚       â””â”€â”€ QueueTokenRepository.java
â”‚
â”œâ”€â”€ interfaces/                     # ì¸í„°í˜ì´ìŠ¤ ê³„ì¸µ
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ concert/
â”‚       â”‚   â”œâ”€â”€ ConcertController.java
â”‚       â”‚   â””â”€â”€ dto/
â”‚       â”œâ”€â”€ reservation/
â”‚       â”‚   â”œâ”€â”€ ReservationController.java
â”‚       â”‚   â””â”€â”€ dto/
â”‚       â”œâ”€â”€ payment/
â”‚       â”‚   â”œâ”€â”€ PaymentController.java
â”‚       â”‚   â””â”€â”€ dto/
â”‚       â”œâ”€â”€ point/
â”‚       â”‚   â”œâ”€â”€ PointController.java
â”‚       â”‚   â””â”€â”€ dto/
â”‚       â””â”€â”€ queue/
â”‚           â”œâ”€â”€ QueueController.java
â”‚           â””â”€â”€ dto/
â”‚
â”œâ”€â”€ common/                         # ê³µí†µ ëª¨ë“ˆ
â”‚   â””â”€â”€ exception/
â”‚       â”œâ”€â”€ BusinessException.java
â”‚       â”œâ”€â”€ GlobalExceptionHandler.java
â”‚       â””â”€â”€ ProblemDetail.java
â”‚
â””â”€â”€ config/                         # ì„¤ì •
    â”œâ”€â”€ DataInitializer.java
    â”œâ”€â”€ jpa/
    â”‚   â””â”€â”€ JpaConfig.java
    â””â”€â”€ swagger/
        â””â”€â”€ SwaggerConfig.java
```

### ì˜ì¡´ì„± ë°©í–¥

```
Interfaces â†’ Application â†’ Domain
                â†“
         Infrastructure (Spring Data JPA)
```

- **Domain**: ì˜ì¡´ì„± ì—†ìŒ (POJO + JPA ì–´ë…¸í…Œì´ì…˜ë§Œ)
- **Application**: Domainì—ë§Œ ì˜ì¡´
- **Interfaces**: Applicationì—ë§Œ ì˜ì¡´
- **Infrastructure**: Spring Data JPAê°€ Domain Repository ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„

---

## 5. ë™ì‹œì„± ì œì–´

### 5.1 ë‚™ê´€ì  ë½ (Optimistic Lock)

**ì ìš© ì—”í‹°í‹°:**
- `Seat` - ì¢Œì„ ì˜ˆì•½ ì‹œ ë²„ì „ ì¶©ëŒ ê°ì§€
- `PointBalance` - í¬ì¸íŠ¸ ì¶©ì „ ì‹œ ë²„ì „ ì¶©ëŒ ê°ì§€

```java
@Entity
public class Seat {
    @Version
    private Long version;  // ë‚™ê´€ì  ë½
}
```

**ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:**
- ë™ì‹œì— ê°™ì€ ì¢Œì„ ì˜ˆì•½ ì‹œë„ â†’ ë¨¼ì € ì»¤ë°‹í•œ íŠ¸ëœì­ì…˜ë§Œ ì„±ê³µ
- `OptimisticLockingFailureException` ë°œìƒ ì‹œ ì¬ì‹œë„ ìš”ì²­

### 5.2 ë¹„ê´€ì  ë½ (Pessimistic Lock)

**ì ìš© ìœ„ì¹˜:**
- `PointBalanceRepository.findByUserIdWithLock()` - í¬ì¸íŠ¸ ì°¨ê° ì‹œ

```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
Optional<PointBalance> findByUserIdWithLock(String userId);
```

**ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:**
- ê²°ì œ ì‹œ í¬ì¸íŠ¸ ì°¨ê° â†’ ë™ì‹œ ìš”ì²­ ì‹œ ìˆœì°¨ ì²˜ë¦¬

### 5.3 ë™ì‹œì„± ì œì–´ ì „ëµ

| ìƒí™© | ì „ëµ | ì´ìœ  |
|------|------|------|
| ì¢Œì„ ì˜ˆì•½ | ë‚™ê´€ì  ë½ | ì¶©ëŒ ë¹ˆë„ ë‚®ìŒ, ì„±ëŠ¥ ìš°ì„  |
| í¬ì¸íŠ¸ ì¶©ì „ | ë‚™ê´€ì  ë½ | ì¶©ëŒ ë¹ˆë„ ë‚®ìŒ |
| í¬ì¸íŠ¸ ì°¨ê° | ë¹„ê´€ì  ë½ | ì •í•©ì„± ì¤‘ìš”, ì”ì•¡ ë¶€ì¡± ë°©ì§€ |

---

## 6. ì˜ˆì™¸ ì²˜ë¦¬

### 6.1 ì˜ˆì™¸ ê³„ì¸µ

```
RuntimeException
â””â”€â”€ BusinessException (ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸)
    â”œâ”€â”€ message: ì‚¬ìš©ì ë©”ì‹œì§€
    â”œâ”€â”€ errorCode: ì—ëŸ¬ ì½”ë“œ (ex: "seat-not-found")
    â””â”€â”€ httpStatus: HTTP ìƒíƒœ ì½”ë“œ
```

### 6.2 ì „ì—­ ì˜ˆì™¸ í•¸ë“¤ëŸ¬

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ProblemDetail> handleBusinessException(BusinessException ex) {
        // RFC 7807 í˜•ì‹ ì‘ë‹µ
    }
    
    @ExceptionHandler(OptimisticLockingFailureException.class)
    public ResponseEntity<ProblemDetail> handleOptimisticLockingFailure(Exception ex) {
        // 409 Conflict ì‘ë‹µ
    }
}
```

### 6.3 ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ (RFC 7807)

```json
{
  "type": "https://api.concert.com/problems/seat-not-found",
  "title": "BusinessException",
  "status": 404,
  "detail": "ì¢Œì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
  "instance": null,
  "timestamp": "2025-01-20T10:30:00"
}
```

---

## 7. ìŠ¤ì¼€ì¤„ë§

### ExpirationScheduler

| Task | ì£¼ê¸° | ì„¤ëª… |
|------|------|------|
| `releaseExpiredReservations` | 1ë¶„ | ë§Œë£Œëœ ì„ì‹œ ì˜ˆì•½ í•´ì œ |
| `activateWaitingTokens` | 30ì´ˆ | ëŒ€ê¸° ì¤‘ í† í° í™œì„±í™” (ìµœëŒ€ 100ê°œ) |
| `cleanupExpiredTokens` | 5ë¶„ | ë§Œë£Œëœ í† í° ì •ë¦¬ |

### ì„¤ì •

```java
@SpringBootApplication
@EnableScheduling  // ìŠ¤ì¼€ì¤„ë§ í™œì„±í™”
public class ServerApplication { }
```

---

## ğŸ“Š ERD

```mermaid
erDiagram
    CONCERT_SCHEDULE ||--o{ SEAT : has
    SEAT ||--o| RESERVATION : reserved_by
    RESERVATION ||--o| PAYMENT : paid_by
    POINT_BALANCE ||--o{ PAYMENT : uses
    QUEUE_TOKEN }o--|| USER : belongs_to

    CONCERT_SCHEDULE {
        bigint id PK
        date concert_date UK
        int total_seats
        int available_seats
    }

    SEAT {
        bigint id PK
        string concert_date
        int seat_number
        string status
        string reserved_user_id
        datetime reserved_until
        bigint version
    }

    RESERVATION {
        bigint id PK
        string user_id
        bigint seat_id FK
        string concert_date
        int seat_number
        bigint price
        string status
        datetime reserved_at
        datetime reserved_until
        datetime confirmed_at
    }

    PAYMENT {
        bigint id PK
        bigint reservation_id FK
        string user_id
        bigint amount
        string status
        datetime paid_at
    }

    POINT_BALANCE {
        string user_id PK
        bigint balance
        bigint version
    }

    QUEUE_TOKEN {
        bigint id PK
        string user_id
        string token UK
        string status
        int position
        datetime expires_at
        datetime created_at
    }
```

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- [ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨](./SEQUENCE_DIAGRAM.md)
- [DDL ìŠ¤í¬ë¦½íŠ¸](./schema.sql)
- [API ëª…ì„¸ì„œ](./openapi.yaml)
